From 47a73eab5c66ef6e8938417dfda3b6d79bc55d0b Mon Sep 17 00:00:00 2001
From: Behdad Esfahbod <behdad@behdad.org>
Date: Fri, 25 Apr 2025 16:21:12 -0600
Subject: [PATCH] [coretext] Add a version check

Fixes https://github.com/harfbuzz/harfbuzz/issues/5300
---
 src/hb-coretext.cc | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/src/hb-coretext.cc b/src/hb-coretext.cc
index 7d7dfc0a8dc..ea2d5b6e978 100644
--- src/hb-coretext.cc
+++ src/hb-coretext.cc
@@ -205,10 +205,18 @@ create_cg_font (hb_blob_t *blob, unsigned int index)
 
   if (unlikely (named_instance_index != 0))
   {
+    // https://github.com/harfbuzz/harfbuzz/issues/5300
+#if (defined(__IPHONE_OS_VERSION_MIN_REQUIRED) && __IPHONE_OS_VERSION_MIN_REQUIRED >= 110000) || \
+    (defined(__MAC_OS_X_VERSION_MIN_REQUIRED) && __MAC_OS_X_VERSION_MIN_REQUIRED >= 101300) || \
+    (defined(__TV_OS_VERSION_MIN_REQUIRED) && __TV_OS_VERSION_MIN_REQUIRED >= 110000) || \
+    (defined(__WATCH_OS_VERSION_MIN_REQUIRED) && __WATCH_OS_VERSION_MIN_REQUIRED >= 40000) || \
+    (defined(__MACCATALYST_VERSION_MIN_REQUIRED) && __MACCATALYST_VERSION_MIN_REQUIRED >= 130100) || \
+    (defined(__VISION_OS_VERSION_MIN_REQUIRED) && __VISION_OS_VERSION_MIN_REQUIRED >= 10000)
     auto ct_font_desc_array = CTFontManagerCreateFontDescriptorsFromData (CFDataCreate (kCFAllocatorDefault, (const UInt8 *) blob_data, blob_length));
-    if (unlikely (!ct_font_desc_array))
-      return nullptr;
-    return create_cg_font (ct_font_desc_array, named_instance_index);
+    if (likely (ct_font_desc_array))
+      return create_cg_font (ct_font_desc_array, named_instance_index);
+#endif
+    return nullptr;
   }
 
   hb_blob_reference (blob);

From fcedcf81119469c96e9d6a2d937710e445ad1815 Mon Sep 17 00:00:00 2001
From: Behdad Esfahbod <behdad@behdad.org>
Date: Fri, 25 Apr 2025 19:04:37 -0600
Subject: [PATCH] [coretext] Another old-system build fix

Fixes https://github.com/harfbuzz/harfbuzz/issues/5300#issuecomment-2831684725
---
 test/api/test-coretext.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/test/api/test-coretext.c b/test/api/test-coretext.c
index 0b14625d8af..ce884c5f94b 100644
--- test/api/test-coretext.c
+++ test/api/test-coretext.c
@@ -79,6 +79,10 @@ test_native_coretext_variations (void)
   unsigned int length;
 
   // System UI font is a variable font
+#if !(defined(TARGET_OS_IPHONE) && TARGET_OS_IPHONE) && MAC_OS_X_VERSION_MIN_REQUIRED < 1080
+# define kCTFontUIFontSystem kCTFontSystemFontType
+# define kCTFontUIFontEmphasizedSystem kCTFontEmphasizedSystemFontType
+#endif
   ctfont = CTFontCreateUIFontForLanguage (kCTFontUIFontSystem, 12.0, CFSTR ("en-US"));
   g_assert_nonnull (ctfont);
 
