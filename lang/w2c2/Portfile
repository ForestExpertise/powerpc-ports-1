# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               cmake 1.1
PortGroup               github 1.0
PortGroup               legacysupport 1.1

# clock_gettime
legacysupport.newest_darwin_requires_legacy 15

github.setup            turbolent w2c2 06022f2ff69bdc7d0514a49a18004440a03c3a61
version                 2025.04.02
revision                0

categories              lang devel
license                 MIT
maintainers             {@barracuda156 macos-powerpc.org:barracuda} openmaintainer

description             Translates WebAssembly modules to portable C
long_description        {*}${description}

checksums               rmd160  2c77967b06d31b795df9425d4258a6cc5a9fc0a9 \
                        sha256  1d2adde68657535a7f275f179a61c420679233c56a0eb2ab5a1b75c26f9ec87a \
                        size    28418489
github.tarball_from     archive

patchfiles              0001-Use-warning-flags-compatible-with-Apple-gcc.patch
# https://github.com/turbolent/w2c2/issues/120
patchfiles-append       0002-Drop-Werror-conversion-for-now.patch

compiler.c_standard     1990

depends_lib-append      port:libdwarf-code

# Default is static, and dynamic lib fails to link:
# Undefined symbols for architecture arm64: "_wasiMemory"
configure.args-append   -DSHARED_LIB:BOOL=OFF

destroot {
    # This assumes static build, see above:
    set runtime lib${name}wasi.a
    copy ${cmake.build_dir}/wasi/${runtime} ${destroot}${prefix}/lib/
    copy ${cmake.build_dir}/${name}/${name} ${destroot}${prefix}/bin/
    set docdir ${prefix}/share/doc/${name}
    xinstall -d ${destroot}${docdir}
    xinstall -m 0644 -W ${worksrcpath} LICENSE README.md ${destroot}${docdir}
}
