# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           legacysupport 1.1
PortGroup           wxWidgets 1.0

# Original upstream is dead: https://github.com/anonbeat/guayadeque
# See also: https://github.com/openmonk/guayadeque-scripts/issues/1
github.setup        thothix guayadeque 0.7.1 v
revision            1
categories          audio
license             GPL-3
maintainers         {@barracuda156 macos-powerpc.org:barracuda} openmaintainer

description         Guayadeque is a music management program
long_description    {*}${description} designed for all music enthusiasts.
checksums           rmd160  7043067976081010855bf00594d277abf7649760 \
                    sha256  6c6e8c95ced402544ca395d8d8b9e13342e9610c048490b1113307dce50b2f3b \
                    size    2260739
github.tarball_from archive

installs_libs       no

wxWidgets.use       wxGTK-3.2

# guayadeque(27054) malloc: *** error for object 0xa04da754: pointer being freed was not allocated
legacysupport.redirect_bins ${name}

patch.pre_args-replace  -p0 -p1

# See: https://github.com/thothix/guayadeque/pull/64
patchfiles-append   0001-Fix-build-on-case-insensitive-filesystems.patch

# https://github.com/thothix/guayadeque/commit/390c5cb7229f2fa2ff6ebe48cc2a3d2981d8d68c
patchfiles-append   0002-macOS-support-CoreAudio-out.patch

# See: https://github.com/thothix/guayadeque/issues/62
patchfiles-append   0003-Minor-fix-to-CMakeLists.patch \

# https://github.com/thothix/guayadeque/commit/f3da58ba2fbeb066267c6312574b8de41a1b30f8
patchfiles-append   0004-MainApp.cpp.patch

post-patch {
    reinplace "s|@PREFIX@|${prefix}|" ${worksrcpath}/CMakeLists.txt
}

depends_build-append \
                    port:gettext \
                    path:bin/pkg-config:pkgconfig

depends_lib-append  port:curl \
                    port:dbus \
                    path:lib/pkgconfig/gdk-pixbuf-2.0.pc:gdk-pixbuf2 \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    port:gstreamer1 \
                    port:gstreamer1-gst-libav \
                    port:gstreamer1-gst-plugins-base \
                    port:gstreamer1-gst-plugins-good \
                    path:lib/pkgconfig/gtk+-3.0.pc:gtk3 \
                    path:lib/pkgconfig/icu-uc.pc:icu \
                    port:jsoncpp \
                    port:libgpod \
                    port:sqlite3 \
                    port:taglib \
                    port:wxsqlite3 \
                    port:${wxWidgets.port}

depends_run-append  port:desktop-file-utils

compiler.cxx_standard   2017

configure.args-append \
                    -DENABLE_IPOD=ON \
                    -DwxWidgets_CONFIG_EXECUTABLE=${wxWidgets.wxconfig}

# FIXME: perhaps on wxGTK side, but there are a lot of these:
# guayadeque[27435:903] *** __NSAutoreleaseNoPool(): Object 0xb0c6a80 of class NSCFString autoreleased with no pool in place - just leaking

post-activate {
    system "${prefix}/bin/gtk-update-icon-cache -f -t ${prefix}/share/icons/hicolor"
    system "${prefix}/bin/update-desktop-database ${prefix}/share/applications"
}

notes "
The app needs dbus session. Please run the following:\
launchctl load -w /Library/LaunchAgents/org.freedesktop.dbus-session.plist
"
