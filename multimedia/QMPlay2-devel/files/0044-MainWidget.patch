From 59d1da51492ae3f8c1a195ac10d924857bf13f53 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Wed, 16 Apr 2025 05:48:24 +0800
Subject: [PATCH 44/60] MainWidget.*

---
 src/gui/MainWidget.cpp | 56 +++++++++++-------------------------------
 src/gui/MainWidget.hpp | 30 +++++++++++-----------
 2 files changed, 31 insertions(+), 55 deletions(-)

diff --git a/src/gui/MainWidget.cpp b/src/gui/MainWidget.cpp
index 2ccff11a..ec20d170 100644
--- a/src/gui/MainWidget.cpp
+++ b/src/gui/MainWidget.cpp
@@ -32,8 +32,6 @@
 #include <QListWidget>
 #ifdef Q_OS_MACOS
     #include <QProcess>
-    #include <QScreen>
-    #include <QWindow>
 #endif
 #ifdef Q_OS_WIN
     #include <QWinThumbnailToolButton>
@@ -62,7 +60,8 @@
 #include <VolWidget.hpp>
 #include <ScreenSaver.hpp>
 #ifdef Q_OS_MACOS
-    #include <QMPlay2MacExtensions.hpp>
+    #include <Carbon/Carbon.h>
+    extern void qt_mac_set_dock_menu(QMenu *);
 #endif
 
 using Functions::timeToStr;
@@ -76,21 +75,6 @@ using Functions::timeToStr;
 
 #include <cmath>
 
-/* MainWidgetTmpStyle -  dock widget separator extent must be larger for touch screens */
-class MainWidgetTmpStyle final : public QCommonStyle
-{
-public:
-    ~MainWidgetTmpStyle() = default;
-
-    int pixelMetric(PixelMetric metric, const QStyleOption *option, const QWidget *widget) const override
-    {
-        const int pM = QCommonStyle::pixelMetric(metric, option, widget);
-        if (metric == QStyle::PM_DockWidgetSeparatorExtent)
-            return pM * 5 / 2;
-        return pM;
-    }
-};
-
 #ifndef Q_OS_MACOS
 static void copyMenu(QMenu *dest, QMenu *src, QMenu *dontCopy = nullptr)
 {
@@ -110,25 +94,13 @@ static void copyMenu(QMenu *dest, QMenu *src, QMenu *dontCopy = nullptr)
 #endif
 
 /* MainWidget */
-MainWidget::MainWidget(QList<QPair<QString, QString>> &arguments) :
+MainWidget::MainWidget(QPair<QStringList, QStringList> &arguments) :
     updater(this)
 {
     QMPlay2GUI.videoAdjustment = new VideoAdjustmentW;
     QMPlay2GUI.shortcutHandler = new ShortcutHandler(this);
     QMPlay2GUI.mainW = this;
 
-    /* Looking for touch screen */
-    for (const QTouchDevice *touchDev : QTouchDevice::devices())
-    {
-        /* Touchscreen found */
-        if (touchDev->type() == QTouchDevice::TouchScreen)
-        {
-            MainWidgetTmpStyle mainWidgetTmpStyle;
-            setStyle(&mainWidgetTmpStyle);
-            break;
-        }
-    }
-
     setObjectName("MainWidget");
 
     settingsW = nullptr;
@@ -284,7 +256,7 @@ MainWidget::MainWidget(QList<QPair<QString, QString>> &arguments) :
     connect(playlistDock, SIGNAL(play(const QString &)), &playC, SLOT(play(const QString &)));
     connect(playlistDock, SIGNAL(repeatEntry(bool)), &playC, SLOT(repeatEntry(bool)));
     connect(playlistDock, SIGNAL(stop()), &playC, SLOT(stop()));
-    connect(&playC, SIGNAL(videoNotStarted()), this, SLOT(onVideoNotStarted()));
+    connect(playlistDock, SIGNAL(addAndPlayRestoreWindow()), this, SLOT(handleAddAndPlayRestoreWindow()));
 
     connect(seekS, SIGNAL(valueChanged(int)), this, SLOT(seek(int)));
     connect(seekS, SIGNAL(mousePosition(int)), this, SLOT(mousePositionOnSlider(int)));
@@ -318,15 +290,10 @@ MainWidget::MainWidget(QList<QPair<QString, QString>> &arguments) :
     connect(&playC, SIGNAL(updateBufferedRange(int, int)), seekS, SLOT(drawRange(int, int)));
     connect(&playC, SIGNAL(updateWindowTitle(const QString &)), this, SLOT(updateWindowTitle(const QString &)));
     connect(&playC, SIGNAL(updateImage(const QImage &)), videoDock, SLOT(updateImage(const QImage &)));
-    connect(&playC, &PlayClass::videoStarted, this, &MainWidget::videoStarted);
+    connect(&playC, SIGNAL(videoNotStarted()), this, SLOT(handleVideoNotStarted()));
     connect(playlistDock, SIGNAL(addAndPlayRestoreWindow()), this, SLOT(onAddAndPlayRestoreWindow()));
     connect(&playC, SIGNAL(uncheckSuspend()), this, SLOT(uncheckSuspend()));
-    connect(&playC, &PlayClass::setVideoCheckState, this, [this](bool rotate90, bool hFlip, bool vFlip, bool spherical) {
-        menuBar->playback->videoFilters->rotate90->setChecked(rotate90);
-        menuBar->playback->videoFilters->hFlip->setChecked(hFlip);
-        menuBar->playback->videoFilters->vFlip->setChecked(vFlip);
-        menuBar->playback->videoFilters->spherical->setChecked(spherical);
-    });
+    connect(&playC, SIGNAL(setVideoCheckState(bool, bool, bool, bool)), this, SLOT(handleSetVideoCheckState(bool, bool, bool, bool)));
     /**/
 
     if (settings.getBool("MainWidget/TabPositionNorth"))
@@ -554,11 +521,11 @@ void MainWidget::updateWindowTitle(const QString &t)
     setWindowTitle(title);
 }
 
-void MainWidget::onAddAndPlayRestoreWindow() {
+void MainWidget::handleAddAndPlayRestoreWindow() {
     m_restoreWindowOnVideo = true;
 }
 
-void MainWidget::onVideoNotStarted() {
+void MainWidget::handleVideoNotStarted() {
     m_restoreWindowOnVideo = false;
 }
 
@@ -1807,3 +1774,10 @@ void MainWidget::fileOpenTimerTimeout()
     filesToAdd.clear();
 }
 #endif
+
+void MainWidget::handleSetVideoCheckState(bool rotate90, bool hFlip, bool vFlip, bool spherical) {
+    menuBar->playback->videoFilters->rotate90->setChecked(rotate90);
+    menuBar->playback->videoFilters->hFlip->setChecked(hFlip);
+    menuBar->playback->videoFilters->vFlip->setChecked(vFlip);
+    menuBar->playback->videoFilters->spherical->setChecked(spherical);
+}
diff --git a/src/gui/MainWidget.hpp b/src/gui/MainWidget.hpp
index d2657c62..a7015dc6 100644
--- a/src/gui/MainWidget.hpp
+++ b/src/gui/MainWidget.hpp
@@ -42,14 +42,18 @@ class QMPlay2Extensions;
     class QWinTaskbarProgress;
 #endif
 
-class MainWidget final : public QMainWindow
+class MainWidget : public QMainWindow
 {
     friend class QMPlay2GUIClass;
     Q_PROPERTY(bool fullScreen READ getFullScreen)
     Q_OBJECT
 public:
-    MainWidget(QList<QPair<QString, QString>> &argument);
-    ~MainWidget();
+    MainWidget(QPair<QStringList, QStringList> &argument);
+    ~MainWidget() final;
+public slots:
+    void handleAddAndPlayRestoreWindow();
+    void handleVideoNotStarted();
+    void handleSetVideoCheckState(bool rotate90, bool hFlip, bool vFlip, bool spherical);
 private slots:
     void detachFromPipe();
 
@@ -60,8 +64,6 @@ private slots:
     void audioChannelsChanged();
 
     void updateWindowTitle(const QString &t = QString());
-    void onAddAndPlayRestoreWindow();
-    void onVideoNotStarted();
     void videoStarted(bool noVideo);
 
     void togglePlay();
@@ -126,7 +128,7 @@ private slots:
 private:
     void savePlistHelper(const QString &, const QString &, bool);
 
-    QMenu *createPopupMenu() override;
+    QMenu *createPopupMenu() override final;
 
     void showToolBar(bool);
     void hideDocks();
@@ -139,15 +141,15 @@ private:
     void setWindowsTaskBarFeatures();
 #endif
 
-    void keyPressEvent(QKeyEvent *) override;
-    void mouseMoveEvent(QMouseEvent *) override;
-    void leaveEvent(QEvent *) override;
-    void closeEvent(QCloseEvent *) override;
-    void moveEvent(QMoveEvent *) override;
-    void showEvent(QShowEvent *) override;
-    void hideEvent(QHideEvent *) override;
+    void keyPressEvent(QKeyEvent *) override final;
+    void mouseMoveEvent(QMouseEvent *) override final;
+    void leaveEvent(QEvent *) override final;
+    void closeEvent(QCloseEvent *) override final;
+    void moveEvent(QMoveEvent *) override final;
+    void showEvent(QShowEvent *) override final;
+    void hideEvent(QHideEvent *) override final;
 
-    bool eventFilter(QObject *obj, QEvent *event) override;
+    bool eventFilter(QObject *obj, QEvent *event) override final;
 
 #ifdef Q_OS_MACOS
     void fileOpenTimerTimeout();
-- 
2.49.0

