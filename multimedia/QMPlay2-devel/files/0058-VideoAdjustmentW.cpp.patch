From dd4a39d8ce2f4dbcb1110f8169b8b261e3502273 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Fri, 18 Apr 2025 14:34:29 +0800
Subject: [PATCH 58/60] VideoAdjustmentW.cpp

---
 src/gui/VideoAdjustmentW.cpp | 39 ++++++++++++++++++++----------------
 src/gui/VideoAdjustmentW.hpp |  5 ++++-
 2 files changed, 26 insertions(+), 18 deletions(-)

diff --git a/src/gui/VideoAdjustmentW.cpp b/src/gui/VideoAdjustmentW.cpp
index d2936c50..ff2b8c61 100644
--- a/src/gui/VideoAdjustmentW.cpp
+++ b/src/gui/VideoAdjustmentW.cpp
@@ -71,7 +71,6 @@ VideoAdjustmentW::VideoAdjustmentW()
         slider->setWheelStep(1);
         slider->setValue(0);
 
-        // Old-style connect for Slider::valueChanged
         connect(slider, SIGNAL(valueChanged(int)), this, SLOT(onSliderValueChanged(int)));
 
         m_sliders.push_back(slider);
@@ -79,23 +78,23 @@ VideoAdjustmentW::VideoAdjustmentW()
         QAction *actionDown = new QAction(this);
         QAction *actionUp = new QAction(this);
 
-        // Old-style connect for QAction::triggered
         connect(actionDown, SIGNAL(triggered()), this, SLOT(onActionDownTriggered()));
         connect(actionUp, SIGNAL(triggered()), this, SLOT(onActionUpTriggered()));
 
-        m_actions.push_back({actionDown, actionUp});
+        m_actions.push_back(std::make_pair(actionDown, actionUp));
 
         layout->addWidget(titleL, i, 0);
         layout->addWidget(slider, i, 1);
         layout->addWidget(valueL, i, 2);
+
+        // Store the title and value labels in a map for later access
+        m_labelMap[slider] = std::make_pair(valueL, titleL);
     }
 
     QPushButton *resetB = new QPushButton(tr("Reset"));
-    // Old-style connect for QPushButton::clicked
     connect(resetB, SIGNAL(clicked()), this, SLOT(onResetClicked()));
 
     m_resetAction = new QAction(tr("Reset video adjustments"), this);
-    // Old-style connect for QAction::triggered
     connect(m_resetAction, SIGNAL(triggered()), resetB, SLOT(click()));
 
     layout->addWidget(resetB, layout->rowCount(), 0, 1, 3);
@@ -173,10 +172,10 @@ void VideoAdjustmentW::addActionsToWidget(QWidget *w)
 
 void VideoAdjustmentW::onSliderValueChanged(int value)
 {
-    int index = m_sliders.indexOf(qobject_cast<Slider *>(sender()));
-    if (index != -1) {
-        QLabel *valueL = static_cast<QLabel *>(layout()->itemAtPosition(index, 2)->widget());
-        QLabel *titleL = static_cast<QLabel *>(layout()->itemAtPosition(index, 0)->widget());
+    Slider *slider = qobject_cast<Slider *>(sender());
+    if (slider && m_labelMap.count(slider)) {
+        QLabel *valueL = m_labelMap[slider].first;
+        QLabel *titleL = m_labelMap[slider].second;
         valueL->setText(QString::number(value));
         emit videoAdjustmentChanged(titleL->text() + QString::number(value));
     }
@@ -184,19 +183,25 @@ void VideoAdjustmentW::onSliderValueChanged(int value)
 
 void VideoAdjustmentW::onActionDownTriggered()
 {
-    int index = m_actions.indexOf(qobject_cast<QAction *>(sender()));
-    if (index != -1) {
-        Slider *slider = m_sliders[index];
-        slider->setValue(slider->value() - g_step);
+    QAction *action = qobject_cast<QAction *>(sender());
+    for (size_t i = 0; i < m_actions.size(); ++i) {
+        if (m_actions[i].first == action) {
+            Slider *slider = m_sliders[i];
+            slider->setValue(slider->value() - g_step);
+            break;
+        }
     }
 }
 
 void VideoAdjustmentW::onActionUpTriggered()
 {
-    int index = m_actions.indexOf(qobject_cast<QAction *>(sender()));
-    if (index != -1) {
-        Slider *slider = m_sliders[index];
-        slider->setValue(slider->value() + g_step);
+    QAction *action = qobject_cast<QAction *>(sender());
+    for (size_t i = 0; i < m_actions.size(); ++i) {
+        if (m_actions[i].second == action) {
+            Slider *slider = m_sliders[i];
+            slider->setValue(slider->value() + g_step);
+            break;
+        }
     }
 }
 
diff --git a/src/gui/VideoAdjustmentW.hpp b/src/gui/VideoAdjustmentW.hpp
index 0177f0ba..fdd04bd9 100644
--- a/src/gui/VideoAdjustmentW.hpp
+++ b/src/gui/VideoAdjustmentW.hpp
@@ -20,8 +20,10 @@
 
 #include <QWidget>
 
-#include <vector>
 #include <array>
+#include <map>
+#include <utility>
+#include <vector>
 
 class ModuleParams;
 class QAction;
@@ -51,6 +53,7 @@ private:
     std::vector<Slider *> m_sliders;
     std::vector<std::array<QAction *, 2>> m_actions;
     QAction *m_resetAction = nullptr;
+    std::map<Slider *, std::pair<QLabel *, QLabel *>> m_labelMap;
 
 private slots:
     void onSliderValueChanged(int value);
-- 
2.49.0

