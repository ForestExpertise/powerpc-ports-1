From 59d02a7f2e5abccc2bc48ab0fec0e3e375e69b1e Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Thu, 22 May 2025 09:26:57 +0800
Subject: [PATCH 70/70] YouTubeDL.cpp: backport 85b4e5a

---
 src/qmplay2/YouTubeDL.cpp | 31 +++++++------------------------
 1 file changed, 7 insertions(+), 24 deletions(-)

diff --git a/src/qmplay2/YouTubeDL.cpp b/src/qmplay2/YouTubeDL.cpp
index 03924dd3..fe64c465 100644
--- a/src/qmplay2/YouTubeDL.cpp
+++ b/src/qmplay2/YouTubeDL.cpp
@@ -23,6 +23,7 @@
 #include <Functions.hpp>
 #include <CppUtils.hpp>
 
+#include <QRegExp>
 #include <QFileInfo>
 #include <QMutex>
 #include <QFile>
@@ -37,7 +38,7 @@ static QMutex g_mutex(QMutex::Recursive);
 
 QString YouTubeDL::getFilePath()
 {
-    return QMPlay2Core.getSettingsDir() + "youtube-dl"
+    return QMPlay2Core.getSettingsDir() + "yt-dlp"
 #ifdef Q_OS_WIN
     ".exe"
 #endif
@@ -306,7 +307,7 @@ bool YouTubeDL::download()
 {
     // Mutex must be locked here
 
-    const QString downloadUrl = "https://yt-dl.org/downloads/latest/youtube-dl"
+    const QString downloadUrl = "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp"
 #ifdef Q_OS_WIN
     ".exe"
 #endif
@@ -390,29 +391,11 @@ bool YouTubeDL::update()
         {
             qCritical() << "youtube-dl update failed:" << updateOutput;
         }
-        else if (m_process.exitCode() == 0 && !updateOutput.contains("up-to-date"))
+        else if (m_process.exitCode() == 0 && !updateOutput.contains(QRegExp(R"(up\Wto\Wdate)")))
         {
-#ifdef Q_OS_WIN
-            const QString updatedFile = m_ytDlPath + ".new";
-            QFile::remove(Functions::filePath(m_ytDlPath) + "youtube-dl-updater.bat");
-            if (QFile::exists(updatedFile))
-            {
-                Functions::s_wait(0.2); // Wait 200 ms to be sure that file is closed
-                QFile::remove(m_ytDlPath);
-                if (QFile::rename(updatedFile, m_ytDlPath))
-                {
-#endif
-                    QMPlay2Core.setWorking(false);
-                    emit QMPlay2Core.sendMessage(tr("\"youtube-dl\" has been successfully updated!"), g_name);
-                    return true;
-#ifdef Q_OS_WIN
-                }
-            }
-            else
-            {
-                qDebug() << "Updated youtube-dl file:" + updatedFile + "not found!";
-            }
-#endif
+                QMPlay2Core.setWorking(false);
+                emit QMPlay2Core.sendMessage(tr("\"youtube-dl\" has been successfully updated!"), g_name);
+                return {};
         }
     }
     else if (updating && m_aborted)
-- 
2.48.0

