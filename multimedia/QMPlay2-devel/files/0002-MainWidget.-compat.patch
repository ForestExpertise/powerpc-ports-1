From 826859a075a4689ab336eab13095027986993808 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Fri, 11 Apr 2025 16:59:20 +0800
Subject: [PATCH 02/60] MainWidget.*: compat

---
 src/gui/MainWidget.cpp | 59 ++++++++++++++++++++++++------------------
 src/gui/MainWidget.hpp |  4 +++
 2 files changed, 38 insertions(+), 25 deletions(-)

diff --git a/src/gui/MainWidget.cpp b/src/gui/MainWidget.cpp
index 139dd2a4..2ccff11a 100644
--- a/src/gui/MainWidget.cpp
+++ b/src/gui/MainWidget.cpp
@@ -284,9 +284,7 @@ MainWidget::MainWidget(QList<QPair<QString, QString>> &arguments) :
     connect(playlistDock, SIGNAL(play(const QString &)), &playC, SLOT(play(const QString &)));
     connect(playlistDock, SIGNAL(repeatEntry(bool)), &playC, SLOT(repeatEntry(bool)));
     connect(playlistDock, SIGNAL(stop()), &playC, SLOT(stop()));
-    connect(playlistDock, &PlaylistDock::addAndPlayRestoreWindow, this, [this] {
-        m_restoreWindowOnVideo = true;
-    });
+    connect(&playC, SIGNAL(videoNotStarted()), this, SLOT(onVideoNotStarted()));
 
     connect(seekS, SIGNAL(valueChanged(int)), this, SLOT(seek(int)));
     connect(seekS, SIGNAL(mousePosition(int)), this, SLOT(mousePositionOnSlider(int)));
@@ -321,9 +319,7 @@ MainWidget::MainWidget(QList<QPair<QString, QString>> &arguments) :
     connect(&playC, SIGNAL(updateWindowTitle(const QString &)), this, SLOT(updateWindowTitle(const QString &)));
     connect(&playC, SIGNAL(updateImage(const QImage &)), videoDock, SLOT(updateImage(const QImage &)));
     connect(&playC, &PlayClass::videoStarted, this, &MainWidget::videoStarted);
-    connect(&playC, &PlayClass::videoNotStarted, this, [this] {
-        m_restoreWindowOnVideo = false;
-    });
+    connect(playlistDock, SIGNAL(addAndPlayRestoreWindow()), this, SLOT(onAddAndPlayRestoreWindow()));
     connect(&playC, SIGNAL(uncheckSuspend()), this, SLOT(uncheckSuspend()));
     connect(&playC, &PlayClass::setVideoCheckState, this, [this](bool rotate90, bool hFlip, bool vFlip, bool spherical) {
         menuBar->playback->videoFilters->rotate90->setChecked(rotate90);
@@ -397,10 +393,10 @@ MainWidget::MainWidget(QList<QPair<QString, QString>> &arguments) :
     playlistDock->load(QMPlay2Core.getSettingsDir() + "Playlist.pls");
 
     bool noplay = false;
-    for (const auto &argument : asConst(arguments))
+    for (QList<QPair<QString, QString>>::const_iterator it = arguments.begin(); it != arguments.end(); ++it)
     {
-        const QString &param = argument.first;
-        const QString &data  = argument.second;
+        const QString &param = it->first;
+        const QString &data  = it->second;
         noplay |= (param == "open" || param == "noplay");
         processParam(param, data);
     }
@@ -557,6 +553,15 @@ void MainWidget::updateWindowTitle(const QString &t)
     title.replace('\n', ' ');
     setWindowTitle(title);
 }
+
+void MainWidget::onAddAndPlayRestoreWindow() {
+    m_restoreWindowOnVideo = true;
+}
+
+void MainWidget::onVideoNotStarted() {
+    m_restoreWindowOnVideo = false;
+}
+
 void MainWidget::videoStarted(bool noVideo)
 {
     const bool autoRestoreMainWindowOnVideo = m_restoreWindowOnVideo ? QMPlay2Core.getSettings().getBool("AutoRestoreMainWindowOnVideo") : false;
@@ -693,20 +698,22 @@ void MainWidget::resetSpherical()
 void MainWidget::visualizationFullScreen()
 {
     QWidget *senderW = (QWidget *)sender();
-    const auto maybeGoFullScreen = [this, senderW] {
-        if (!fullScreen)
-        {
-            videoDock->setWidget(senderW);
-            toggleFullScreen();
-        }
-    };
 #ifdef Q_OS_MACOS
-    // On macOS if full screen is toggled to fast after double click, mouse remains in clicked state...
-    QTimer::singleShot(200, maybeGoFullScreen);
+    QTimer::singleShot(200, this, SLOT(maybeGoFullScreen()));
 #else
-    maybeGoFullScreen();
+    maybeGoFullScreen(senderW);
 #endif
 }
+
+void MainWidget::maybeGoFullScreen(QWidget *senderW)
+{
+    if (!fullScreen)
+    {
+        videoDock->setWidget(senderW);
+        toggleFullScreen();
+    }
+}
+
 void MainWidget::hideAllExtensions()
 {
     for (QMPlay2Extensions *QMPlay2Ext : QMPlay2Extensions::QMPlay2ExtensionsList())
@@ -779,7 +786,7 @@ void MainWidget::createMenuBar()
     connect(menuBar->window->toggleVisibility, SIGNAL(triggered()), this, SLOT(toggleVisibility()));
     connect(menuBar->window->toggleFullScreen, SIGNAL(triggered()), this, SLOT(toggleFullScreen()));
     connect(menuBar->window->toggleCompactView, SIGNAL(triggered()), this, SLOT(toggleCompactView()));
-    connect(menuBar->window->alwaysOnTop, &QAction::triggered, this, &MainWidget::toggleAlwaysOnTop);
+    connect(menuBar->window->alwaysOnTop, SIGNAL(triggered(bool)), this, SLOT(toggleAlwaysOnTop(bool)));
     connect(menuBar->window->close, SIGNAL(triggered()), this, SLOT(close()));
 
     connect(menuBar->playlist->add->address, SIGNAL(triggered()), this, SLOT(openUrl()));
@@ -794,7 +801,7 @@ void MainWidget::createMenuBar()
     connect(menuBar->playlist->newGroup, SIGNAL(triggered()), playlistDock, SLOT(newGroup()));
     connect(menuBar->playlist->renameGroup, SIGNAL(triggered()), playlistDock, SLOT(renameGroup()));
     connect(menuBar->playlist->lock, SIGNAL(triggered()), playlistDock, SLOT(toggleLock()));
-    connect(menuBar->playlist->alwaysSync, &QAction::triggered, playlistDock, &PlaylistDock::alwaysSyncTriggered);
+    connect(menuBar->playlist->alwaysSync, SIGNAL(triggered(bool)), playlistDock, SLOT(alwaysSyncTriggered(bool)));
     connect(menuBar->playlist->delEntries, SIGNAL(triggered()), playlistDock, SLOT(delEntries()));
     connect(menuBar->playlist->delNonGroupEntries, SIGNAL(triggered()), playlistDock, SLOT(delNonGroupEntries()));
     connect(menuBar->playlist->clear, SIGNAL(triggered()), playlistDock, SLOT(clear()));
@@ -931,13 +938,11 @@ void MainWidget::createMenuBar()
     secondMenu->addSeparator();
     // Copy action, because PreferencesRole doesn't show in dock menu.
     QAction *settings = new QAction(menuBar->options->settings->icon(), menuBar->options->settings->text(), menuBar->options->settings->parent());
-    connect(settings, &QAction::triggered, menuBar->options->settings, &QAction::trigger);
+    connect(settings, SIGNAL(triggered()), menuBar->options->settings, SLOT(trigger()));
     secondMenu->addAction(settings);
 
     QAction *newInstanceAct = new QAction(tr("New window"), secondMenu);
-    connect(newInstanceAct, &QAction::triggered, [] {
-        QProcess::startDetached(QCoreApplication::applicationFilePath(), {"-noplay"}, QCoreApplication::applicationDirPath());
-    });
+    connect(newInstanceAct, SIGNAL(triggered()), this, SLOT(createNewWindow()));
     secondMenu->addSeparator();
     secondMenu->addAction(newInstanceAct);
 
@@ -1348,6 +1353,10 @@ void MainWidget::readSocket()
         socket->deleteLater();
 }
 
+void MainWidget::createNewWindow() {
+    QProcess::startDetached(QCoreApplication::applicationFilePath(), QStringList() << "-noplay", QCoreApplication::applicationDirPath());
+}
+
 void MainWidget::about()
 {
     if (!aboutW)
diff --git a/src/gui/MainWidget.hpp b/src/gui/MainWidget.hpp
index 2fe04bc5..d2657c62 100644
--- a/src/gui/MainWidget.hpp
+++ b/src/gui/MainWidget.hpp
@@ -60,6 +60,8 @@ private slots:
     void audioChannelsChanged();
 
     void updateWindowTitle(const QString &t = QString());
+    void onAddAndPlayRestoreWindow();
+    void onVideoNotStarted();
     void videoStarted(bool noVideo);
 
     void togglePlay();
@@ -77,6 +79,7 @@ private slots:
     void resetSpherical();
 
     void visualizationFullScreen();
+    void maybeGoFullScreen(QWidget *senderW);
     void hideAllExtensions();
     void toggleVisibility();
     void createMenuBar();
@@ -86,6 +89,7 @@ private slots:
     void toggleFullScreen();
     void showMessage(const QString &, const QString &, int, int);
     void statusBarMessage(const QString &, int ms);
+    void createNewWindow();
 
     void openUrl();
     void openFiles();
-- 
2.49.0

