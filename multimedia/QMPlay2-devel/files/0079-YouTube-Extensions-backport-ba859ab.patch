From 0b4098cc8bb701f346eaead38f5c942a09dacb62 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Fri, 23 May 2025 05:21:12 +0800
Subject: [PATCH 79/80] YouTube, Extensions: backport ba859ab

---
 src/modules/Extensions/Extensions.cpp |  2 +-
 src/modules/Extensions/YouTube.cpp    | 50 +++++++++++++++++++++++----
 src/modules/Extensions/YouTube.hpp    |  9 ++++-
 3 files changed, 53 insertions(+), 8 deletions(-)

diff --git a/src/modules/Extensions/Extensions.cpp b/src/modules/Extensions/Extensions.cpp
index f994a769..18c60222 100644
--- a/src/modules/Extensions/Extensions.cpp
+++ b/src/modules/Extensions/Extensions.cpp
@@ -154,7 +154,7 @@ ModuleSettingsWidget::ModuleSettingsWidget(Module &module) :
 
     m_preferredCodec = new QComboBox;
     m_preferredCodec->setSizePolicy(QSizePolicy(QSizePolicy::Expanding, QSizePolicy::Preferred));
-    m_preferredCodec->addItems({"VP9", "H.264"});
+    m_preferredCodec->addItems({"VP9", "H.264", "AV1"}); // Must match "PreferredCodec" enum
     idx = m_preferredCodec->findText(sets().getString("YouTube/PreferredCodec"));
     m_preferredCodec->setCurrentIndex(idx > -1 ? idx : 0);
 
diff --git a/src/modules/Extensions/YouTube.cpp b/src/modules/Extensions/YouTube.cpp
index 32fed031..25bfa199 100644
--- a/src/modules/Extensions/YouTube.cpp
+++ b/src/modules/Extensions/YouTube.cpp
@@ -401,8 +401,15 @@ YouTube::~YouTube()
 
 bool YouTube::set()
 {
-    const bool oldPpreferredH264 = m_preferredH264;
-    m_preferredH264 = (sets().getString("YouTube/PreferredCodec") == "H.264");
+    const auto preferredCodec = sets().getString("YouTube/PreferredCodec");
+    const auto oldPpreferredCodec = m_preferredCodec;
+
+    if (preferredCodec == "H.264")
+        m_preferredCodec = PreferredCodec::H264;
+    else if (preferredCodec == "AV1")
+        m_preferredCodec = PreferredCodec::AV1;
+    else
+        m_preferredCodec = PreferredCodec::VP9;
 
     const auto qualityActions = m_qualityGroup->actions();
     const auto qualityText = sets().getString("YouTube/QualityPreset");
@@ -413,7 +420,7 @@ bool YouTube::set()
         {
             if (qualityAction->text() == qualityText)
             {
-                if (oldPpreferredH264 != m_preferredH264 && qualityAction->isChecked())
+                if (oldPpreferredCodec != m_preferredCodec && qualityAction->isChecked())
                     qualityAction->setChecked(false); // Force "toggled" signal
                 qualityAction->setChecked(true);
                 qualityActionChecked = true;
@@ -423,7 +430,7 @@ bool YouTube::set()
     }
     if (!qualityActionChecked)
     {
-        if (oldPpreferredH264 != m_preferredH264 && qualityActions[3]->isChecked())
+        if (oldPpreferredCodec != m_preferredCodec && qualityActions[3]->isChecked())
             qualityActions[3]->setChecked(false); // Force "toggled" signal
         qualityActions[3]->setChecked(true);
     }
@@ -669,6 +676,23 @@ void YouTube::setItags(int qualityIdx)
         VP9_2160p60 = 315,
         VP9_4320p60 = 272,
 
+        AV1_480p = 397,
+        AV1_360p = 396,
+        AV1_240p = 395,
+        AV1_144p = 394,
+
+        AV1_HFR_4320p_1 = 571,
+        AV1_HFR_4320p_2 = 402,
+        AV1_HFR_2160p = 401,
+        AV1_HFR_1440p = 400,
+        AV1_HFR_1080p = 399,
+        AV1_HFR_720p = 398,
+
+        AV1_HFR_HIGH_2160p = 701,
+        AV1_HFR_HIGH_1440p = 700,
+        AV1_HFR_HIGH_1080p = 699,
+        AV1_HFR_HIGH_720p = 698,
+
         // Live video
         H264_144p_AAC_48 = 91,
         H264_240p_AAC_48 = 92,
@@ -706,7 +730,7 @@ void YouTube::setItags(int qualityIdx)
 
     QVector<int> qualityPresets[PresetCount];
     {
-        if (!m_preferredH264)
+        if (m_preferredCodec == PreferredCodec::VP9)
         {
             qualityPresets[Preset_480p]  << VP9_480p << H264_480p << VP9_360p << H264_360p << H264_360P_AAC_128 << VP9_240p << H264_240p << VP9_144p << H264_144p;
             qualityPresets[Preset_720p]  << VP9_720p << H264_720p << H264_720P_AAC_128 << qualityPresets[Preset_480p];
@@ -720,7 +744,7 @@ void YouTube::setItags(int qualityIdx)
             qualityPresets[Preset_2160p60] << VP9_2160p60 << H264_2160p60 << qualityPresets[Preset_1440p60];
             qualityPresets[Preset_4320p60] << VP9_4320p60 << qualityPresets[Preset_2160p60];
         }
-        else
+        else if (m_preferredCodec == PreferredCodec::H264)
         {
             qualityPresets[Preset_480p]  << H264_480p << VP9_480p << H264_360p << VP9_360p << H264_360P_AAC_128 << H264_240p << VP9_240p << H264_144p << VP9_144p;
             qualityPresets[Preset_720p]  << H264_720p << VP9_720p << H264_720P_AAC_128 << qualityPresets[Preset_480p];
@@ -734,6 +758,20 @@ void YouTube::setItags(int qualityIdx)
             qualityPresets[Preset_2160p60] << H264_2160p60 << VP9_2160p60 << qualityPresets[Preset_1440p60];
             qualityPresets[Preset_4320p60] << VP9_4320p60 << qualityPresets[Preset_2160p60];
         }
+        else if (m_preferredCodec == PreferredCodec::AV1)
+        {
+            qualityPresets[Preset_480p]  << AV1_480p << AV1_360p << VP9_480p << H264_480p << VP9_360p << H264_360p << H264_360P_AAC_128 << AV1_240p << VP9_240p << H264_240p << AV1_144p << VP9_144p << H264_144p;
+            qualityPresets[Preset_720p]  << VP9_720p << H264_720p << H264_720P_AAC_128 << qualityPresets[Preset_480p];
+            qualityPresets[Preset_1080p] << VP9_1080p << H264_1080p << qualityPresets[Preset_720p];
+            qualityPresets[Preset_1440p] << VP9_1440p << H264_1440p << qualityPresets[Preset_1080p];
+            qualityPresets[Preset_2160p] << VP9_2160p << H264_2160p << qualityPresets[Preset_1440p];
+
+            qualityPresets[Preset_720p60]  << AV1_HFR_HIGH_720p << AV1_HFR_720p << VP9_720p60 << H264_720p60;
+            qualityPresets[Preset_1080p60] << AV1_HFR_HIGH_1080p << AV1_HFR_1080p << VP9_1080p60 << H264_1080p60 << qualityPresets[Preset_720p60];
+            qualityPresets[Preset_1440p60] << AV1_HFR_HIGH_1440p << AV1_HFR_1440p << VP9_1440p60 << H264_1440p60 << qualityPresets[Preset_1080p60];
+            qualityPresets[Preset_2160p60] << AV1_HFR_HIGH_2160p << AV1_HFR_2160p << VP9_2160p60 << H264_2160p60 << qualityPresets[Preset_1440p60];
+            qualityPresets[Preset_4320p60] << AV1_HFR_4320p_1 << AV1_HFR_4320p_2 << VP9_4320p60 << qualityPresets[Preset_2160p60];
+        }
 
         // Append also non-60 FPS itags to 60 FPS itags
         qualityPresets[Preset_720p60]  << qualityPresets[Preset_720p];
diff --git a/src/modules/Extensions/YouTube.hpp b/src/modules/Extensions/YouTube.hpp
index fd4e5da6..12b6ee69 100644
--- a/src/modules/Extensions/YouTube.hpp
+++ b/src/modules/Extensions/YouTube.hpp
@@ -39,6 +39,13 @@ class LineEdit;
 class QLabel;
 class QMenu;
 
+enum class PreferredCodec
+{
+    VP9,
+    H264,
+    AV1,
+};
+
 /**/
 
 class ResultsYoutube : public QTreeWidget
@@ -163,7 +170,7 @@ private:
     int m_sortByIdx = 0;
 
     QMutex m_itagsMutex;
-    bool m_preferredH264 = false;
+    PreferredCodec m_preferredCodec = PreferredCodec::VP9;
     QVector<int> m_videoItags, m_audioItags, m_hlsItags, m_singleUrlItags;
 };
 
-- 
2.49.0

