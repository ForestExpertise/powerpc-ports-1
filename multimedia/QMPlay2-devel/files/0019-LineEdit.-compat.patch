From 9dc7d25d51bac2540b6c9a2e9252d9e4a18920ab Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Tue, 15 Apr 2025 20:28:10 +0800
Subject: [PATCH 19/60] LineEdit.*: compat

---
 src/qmplay2/LineEdit.cpp         | 55 +++++++++++++++++++++++++++-----
 src/qmplay2/headers/LineEdit.hpp | 24 ++++++++++++--
 2 files changed, 69 insertions(+), 10 deletions(-)

diff --git a/src/qmplay2/LineEdit.cpp b/src/qmplay2/LineEdit.cpp
index 6f94853d..72176e1b 100644
--- a/src/qmplay2/LineEdit.cpp
+++ b/src/qmplay2/LineEdit.cpp
@@ -19,19 +19,58 @@
 #include <LineEdit.hpp>
 
 #include <QMPlay2Core.hpp>
+#include <Functions.hpp>
 
-#include <QAction>
+#include <QResizeEvent>
+
+LineEditButton::LineEditButton()
+{
+    const QSize iconSize(16, 16);
+    setToolTip(tr("Clear"));
+    setPixmap(Functions::getPixmapFromIcon(QMPlay2Core.getIconFromTheme("edit-clear"), iconSize, this));
+    resize(iconSize);
+    setCursor(Qt::ArrowCursor);
+}
+
+void LineEditButton::mousePressEvent(QMouseEvent *e)
+{
+    if (e->button() & Qt::LeftButton)
+        emit clicked();
+}
+
+/**/
 
 LineEdit::LineEdit(QWidget *parent)
     : QLineEdit(parent)
 {
-    QAction *clearAct = addAction(QMPlay2Core.getIconFromTheme("edit-clear"), TrailingPosition);
-    connect(clearAct, &QAction::triggered, this, &LineEdit::clearText);
-    connect(this, &LineEdit::textChanged, this, [=](const QString &text) {
-        clearAct->setVisible(!text.isEmpty());
-    });
-    clearAct->setToolTip(tr("Clear"));
-    clearAct->setVisible(false);
+    connect(this, SIGNAL(textChanged(const QString &)), this, SLOT(textChangedSlot(const QString &)));
+    connect(&b, SIGNAL(clicked()), this, SLOT(clearText()));
+    setMinimumWidth(b.width() * 2.5);
+    setTextMargins(0, 0, b.width() * 1.5, 0);
+    b.setParent(this);
+    b.hide();
+}
+
+void LineEdit::resizeEvent(QResizeEvent *e)
+{
+    b.move(e->size().width() - b.width() * 1.5, e->size().height() / 2 - b.height() / 2);
+}
+
+void LineEdit::mousePressEvent(QMouseEvent *e)
+{
+    if (!b.underMouse())
+        QLineEdit::mousePressEvent(e);
+}
+
+void LineEdit::mouseMoveEvent(QMouseEvent *e)
+{
+    if (!b.underMouse())
+        QLineEdit::mouseMoveEvent(e);
+}
+
+void LineEdit::textChangedSlot(const QString &str)
+{
+    b.setVisible(!str.isEmpty());
 }
 
 void LineEdit::clearText()
diff --git a/src/qmplay2/headers/LineEdit.hpp b/src/qmplay2/headers/LineEdit.hpp
index 676be13e..b7606e40 100644
--- a/src/qmplay2/headers/LineEdit.hpp
+++ b/src/qmplay2/headers/LineEdit.hpp
@@ -21,16 +21,36 @@
 #include <QMPlay2Lib.hpp>
 
 #include <QLineEdit>
+#include <QLabel>
 
-class QMPLAY2SHAREDLIB_EXPORT LineEdit final : public QLineEdit
+class LineEditButton : public QLabel
 {
     Q_OBJECT
+public:
+    LineEditButton();
+private:
+    void mousePressEvent(QMouseEvent *) override final;
+signals:
+    void clicked();
+};
+
+/**/
 
+class LineEdit : public QLineEdit
+{
+    Q_OBJECT
 public:
     LineEdit(QWidget *parent = nullptr);
 
-    void clearText();
+private:
+    void resizeEvent(QResizeEvent *) override final;
+    void mousePressEvent(QMouseEvent *) override final;
+    void mouseMoveEvent(QMouseEvent *) override final;
 
+    LineEditButton b;
+private slots:
+    void textChangedSlot(const QString &);
+    void clearText();
 signals:
     void clearButtonClicked();
 };
-- 
2.49.0

