From 23ab54effe2ba86ffce9a25d0f0e249d44171398 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Wed, 16 Apr 2025 08:13:31 +0800
Subject: [PATCH 48/60] Misc minor

---
 src/gui/MainWidget.cpp     | 20 --------------------
 src/gui/MenuBar.cpp        | 21 ---------------------
 src/gui/OSDSettingsW.cpp   |  2 +-
 src/gui/OtherVFiltersW.cpp |  2 +-
 src/gui/SettingsWidget.cpp |  4 ++--
 src/gui/VideoThr.cpp       |  4 ++--
 6 files changed, 6 insertions(+), 47 deletions(-)

diff --git a/src/gui/MainWidget.cpp b/src/gui/MainWidget.cpp
index ec20d170..fec3c152 100644
--- a/src/gui/MainWidget.cpp
+++ b/src/gui/MainWidget.cpp
@@ -1054,30 +1054,17 @@ void MainWidget::toggleFullScreen()
         videoDock->fullScreen(true);
         videoDock->show();
 
-#ifdef Q_OS_MACOS
-        menuBar->window->toggleVisibility->setEnabled(false);
-#endif
         menuBar->window->toggleCompactView->setEnabled(false);
         menuBar->window->toggleFullScreen->setShortcuts(QList<QKeySequence>() << menuBar->window->toggleFullScreen->shortcut() << QKeySequence("ESC"));
         fullScreen = true;
 
-#ifndef Q_OS_MACOS
         showFullScreen();
-#else
-        setWindowFlags(Qt::Window | Qt::FramelessWindowHint);
-        setGeometry(window()->windowHandle()->screen()->geometry());
-        QMPlay2MacExtensions::showSystemUi(windowHandle(), false);
-        show();
-#endif
 
         if (playC.isPlaying())
             QMPlay2GUI.screenSaver->inhibit(1);
     }
     else
     {
-#ifdef Q_OS_MACOS
-        menuBar->window->toggleVisibility->setEnabled(true);
-#endif
         menuBar->window->toggleCompactView->setEnabled(true);
         menuBar->window->toggleFullScreen->setShortcuts(QList<QKeySequence>() << menuBar->window->toggleFullScreen->shortcut());
 
@@ -1085,19 +1072,12 @@ void MainWidget::toggleFullScreen()
         fullScreen = false;
 
 #ifndef Q_OS_ANDROID
-#ifdef Q_OS_MACOS
-        QMPlay2MacExtensions::showSystemUi(windowHandle(), true);
-        setWindowFlags(Qt::Window);
-#else
         showNormal();
 #endif // Q_OS_MACOS
         if (maximized)
             showMaximized();
         else
         {
-#ifdef Q_OS_MACOS
-            showNormal();
-#endif
             setGeometry(savedGeo);
         }
 #else // Q_OS_ANDROID
diff --git a/src/gui/MenuBar.cpp b/src/gui/MenuBar.cpp
index b3ea2162..7210239d 100644
--- a/src/gui/MenuBar.cpp
+++ b/src/gui/MenuBar.cpp
@@ -366,27 +366,6 @@ MenuBar::Playback::VideoFilters::VideoFilters(QMenu *parent) :
     widgetAction->setDefaultWidget(QMPlay2GUI.videoAdjustment);
     QMPlay2GUI.videoAdjustment->setObjectName(videoAdjustmentMenu->title().remove('&'));
     videoAdjustmentMenu->addAction(widgetAction);
-#ifdef Q_OS_MACOS
-    // Update visibility and update geometry of video adjustment widget
-    connect(videoAdjustmentMenu, &VideoFilters::aboutToShow, [] {
-        QWidget *parent = QMPlay2GUI.videoAdjustment->parentWidget();
-        if (parent)
-        {
-            const QString parentObject = parent->metaObject()->className();
-            if (parentObject == "QMacNativeWidget")
-            {
-                QMPlay2GUI.videoAdjustment->update();
-                QMPlay2GUI.videoAdjustment->show();
-            }
-            if (parentObject == "QMacNativeWidget" || parentObject == "QMenu")
-            {
-                QTimer::singleShot(1, [parent] {
-                    QMPlay2GUI.videoAdjustment->setGeometry(parent->rect());
-                });
-            }
-        }
-    });
-#endif
     /**/
     addSeparator();
     newAction(VideoFilters::tr("&Spherical view"), this, spherical, true, QIcon(), true);
diff --git a/src/gui/OSDSettingsW.cpp b/src/gui/OSDSettingsW.cpp
index 7b988cbd..b6a67ca1 100644
--- a/src/gui/OSDSettingsW.cpp
+++ b/src/gui/OSDSettingsW.cpp
@@ -38,7 +38,7 @@ static void appendColon(const QObjectList &objects)
 void OSDSettingsW::init(const QString &prefix, int a, int b, int c, int d, int e, int f, double g, double h, const QColor &i, const QColor &j, const QColor &k)
 {
     Settings &QMPSettings = QMPlay2Core.getSettings();
-    QMPSettings.init(prefix + "/FontName", QGuiApplication::font().family());
+    QMPSettings.init(prefix + "/FontName", QFontComboBox().currentText());
     QMPSettings.init(prefix + "/FontSize", a);
     QMPSettings.init(prefix + "/Spacing", b);
     QMPSettings.init(prefix + "/LeftMargin", c);
diff --git a/src/gui/OtherVFiltersW.cpp b/src/gui/OtherVFiltersW.cpp
index 6d449b42..b4136468 100644
--- a/src/gui/OtherVFiltersW.cpp
+++ b/src/gui/OtherVFiltersW.cpp
@@ -37,7 +37,7 @@ OtherVFiltersW::OtherVFiltersW(bool hw) :
         for (const QString &filter : QMPlay2Core.getSettings().getStringList("VideoFilters"))
         {
             videoFilters.first += filter.mid(1);
-            videoFilters.second += filter.leftRef(1).toInt();
+            videoFilters.second += filter.left(1).toInt();
         }
 
         for (int i = 0; i < videoFilters.first.count(); ++i)
diff --git a/src/gui/SettingsWidget.cpp b/src/gui/SettingsWidget.cpp
index 61f45f92..cbc9990a 100644
--- a/src/gui/SettingsWidget.cpp
+++ b/src/gui/SettingsWidget.cpp
@@ -26,7 +26,7 @@
 #include <Notifies.hpp>
 #include <Main.hpp>
 
-#include <QStandardPaths>
+#include <QDesktopServices>
 #include <QStyleFactory>
 #include <QRadioButton>
 #include <QApplication>
@@ -124,7 +124,7 @@ void SettingsWidget::InitSettings()
 
     QMPSettings.init("AudioLanguage", QString());
     QMPSettings.init("SubtitlesLanguage", QString());
-    QMPSettings.init("screenshotPth", QStandardPaths::standardLocations(QStandardPaths::PicturesLocation).value(0, QDir::homePath()));
+    QMPSettings.init("screenshotPth", QDesktopServices::storageLocation(QDesktopServices::PicturesLocation));
 #ifdef Q_OS_WIN
     QMPSettings.init("screenshotFormat", ".bmp");
 #else
diff --git a/src/gui/VideoThr.cpp b/src/gui/VideoThr.cpp
index 83c03089..05f09dc3 100644
--- a/src/gui/VideoThr.cpp
+++ b/src/gui/VideoThr.cpp
@@ -181,7 +181,7 @@ void VideoThr::initFilters(bool processParams)
     {
         for (QString filterName : QMPSettings.getStringList("VideoFilters"))
         {
-            if (filterName.leftRef(1).toInt()) //if filter is enabled
+            if (filterName.left(1).toInt()) // if filter is enabled
             {
                 VideoFilter *filter = filters.on((filterName = filterName.mid(1)));
                 bool ok = false;
@@ -660,7 +660,7 @@ void VideoThr::screenshot(VideoFrame videoFrame)
             quint16 num = 0;
             for (const QString &f : QDir(dir).entryList({"QMPlay2_snap_?????" + ext}, QDir::Files, QDir::Name))
             {
-                const quint16 n = f.midRef(13, 5).toUShort();
+                const quint16 n = f.mid(13, 5).toUShort();
                 if (n > num)
                     num = n;
             }
-- 
2.49.0

