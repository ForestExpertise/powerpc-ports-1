# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem          1.0
PortGroup           cmake 1.1
PortGroup           github 1.0
PortGroup           qt4 1.0

# Stable version is the regular QMPlay2 port.
# This is exclusively for testing.
set real_name       QMPlay2
name                ${real_name}-devel
conflicts           ${real_name}

# FIXME: Video works, YT does not.
github.setup        zaps166 QMPlay2 19.09.03
revision            2

categories          multimedia
license             LGPL-3
maintainers         {@barracuda156 macos-powerpc.org:barracuda}
description         Qt Media Player 2
long_description    QMPlay2 is a video and audio player. It can play all formats supported by FFmpeg, \
                    libmodplug (including J2B and SFX). It also supports Audio CD, raw files, \
                    Rayman 2 music and chiptunes. It contains YouTube and Prostopleer browser.

checksums           rmd160  b2a8dbaecf070de5a2bdcfc79e140e554bd4a532 \
                    sha256  95d912c68c5d61d9436bb970d410844f57348cbaeb96cac9ec3b3e3057b6eb08 \
                    size    1290624
github.tarball_from archive

patch.pre_args-replace -p0 -p1
patchfiles-append   0001-KeyBindingsDialog.cpp-setSectionResizeMode-to-setRes.patch \
                    0002-MainWidget.-compat.patch \
                    0003-PlaylistDock.cpp-compat.patch \
                    0004-PlaylistWidget.cpp-compat.patch \
                    0005-SettingsWidget.-compat.patch \
                    0006-VideoDock.-compat.patch \
                    0007-Radio.cpp-compat.patch \
                    0008-RadioBrowserModel.cpp-compat.patch \
                    0009-YouTube.-compat-code-with-signal-slot-etc.patch \
                    0010-Downloader.-compat.patch \
                    0011-CMakeLists.txt-support-Qt4.patch \
                    0012-QMPlay2Core.hpp.patch \
                    0013-StreamInfo.hpp.patch \
                    0014-Functions.cpp.patch \
                    0015-NetworkAccess.hpp.patch \
                    0016-QMPlay2Core.cpp.patch \
                    0017-QMPlay2OSD.cpp.patch \
                    0018-Writer.cpp.patch \
                    0019-LineEdit.-compat.patch \
                    0020-QMPLAY2SHAREDLIB_EXPORT-drop.patch \
                    0021-QMPlay2Lib.hpp.patch \
                    0022-IPC.hpp.patch \
                    0023-ColorButton.hpp.patch \
                    0024-Slider.hpp.patch \
                    0025-YouTubeDL.-compat.patch \
                    0026-InDockW.hpp.patch \
                    0027-AudioDevice.h-replace-broken-version-macros.patch \
                    0028-PortAudioWriter.patch \
                    0029-PulseAudio-.hpp.patch \
                    0030-QPainter.patch \
                    0031-Classic.patch \
                    0032-src-gui-more-override-final.patch \
                    0033-EntryProperties.patch \
                    0034-PlayClass.hpp.patch \
                    0035-AudioCD-.hpp.patch \
                    0036-AudioFilters-override-final.patch \
                    0037-Extensions.hpp.patch \
                    0038-LastFM.hpp.patch \
                    0039-Lyrics.hpp.patch \
                    0040-Inputs-override-final.patch \
                    0041-FFmpeg.patch \
                    0042-Main.patch \
                    0043-Radio.patch \
                    0044-MainWidget.patch \
                    0045-PlaylistWidget.hpp.patch \
                    0046-Down.patch \
                    0047-More-override-final.patch \
                    0048-Misc-minor.patch \
                    0049-Downloader.patch \
                    0050-RadioBrowserModel.patch \
                    0051-MainWidget.patch \
                    0052-SettingsWidget.cpp.patch \
                    0053-PlayClass.patch \
                    0054-Downloader.patch \
                    0055-PlaylistWidget.patch \
                    0056-AboutWidget.patch \
                    0057-VideoAdjustmentW.cpp.patch \
                    0058-VideoAdjustmentW.cpp.patch \
                    0059-VideoAdjustmentW.patch \
                    0060-CMakeLists.patch \
                    0061-RadioBrowserModel.patch \
                    0062-Down.patch \
                    0063-YouTube-backport-0f1fde7.patch \
                    0064-YouTube.cpp-backport-77cf66c.patch \
                    0065-YouTube.cpp-backport-0e03873.patch \
                    0066-YouTube.cpp-backport-1935303.patch \
                    0067-YouTube.cpp-backport-491894b-plus-5aaaa4f.patch \
                    0068-YouTube.cpp-backport-3377e5d.patch \
                    0069-YouTube.cpp-backport-2f9281b.patch \
                    0070-YouTubeDL.cpp-backport-85b4e5a.patch \
                    0071-YouTube-move-QJsonDocument.h-into-YouTube.hpp.patch \
                    0072-YouTubeDL.cpp-avoid-broken-bundled-yt-dlp.patch \
                    0073-ScreenSaver.cpp-fix-IOKit-defines.patch \
                    0074-Lyrics.cpp-fix-syntax.patch \
                    0075-YouTube.cpp-backport-a850bc5.patch \
                    0076-YouTube.cpp-backport-6a2caa3-and-b6c43f9.patch \
                    0077-YouTube-Extensions-backport-b4f35c0.patch \
                    0078-YouTube.cpp-backport-11e4913.patch \
                    0079-YouTube-Extensions-backport-ba859ab.patch \
                    0080-YouTube-Extensions-backport-7ffda2f.patch

post-patch {
    reinplace "s|@prefix@|${prefix}|g" ${worksrcpath}/src/modules/Extensions/CMakeLists.txt
    reinplace "s|@destroot@|${destroot}|" ${worksrcpath}/src/gui/CMakeLists.txt
    reinplace "s|@prefix@|${prefix}|g" ${worksrcpath}/src/gui/CMakeLists.txt
    reinplace "s|@qt_libs_dir@|${qt_libs_dir}|" ${worksrcpath}/src/gui/CMakeLists.txt
    reinplace "s|@qt_plugins_dir@|${qt_plugins_dir}|" ${worksrcpath}/src/gui/CMakeLists.txt
}

depends_lib-append  port:ffmpeg \
                    path:lib/pkgconfig/libass.pc:libass \
                    port:libcddb \
                    port:libcdio \
                    port:libsidplayfp \
                    port:portaudio \
                    port:QJson4 \
                    port:taglib \
                    port:zlib

depends_run-append  port:yt-dlp

compiler.cxx_standard   2011

configure.args-append \
                    -DCMAKE_INSTALL_PREFIX=${applications_dir} \
                    -DUSE_ALSA=OFF \
                    -DUSE_AUDIOCD=ON \
                    -DUSE_AUDIOFILTERS=ON \
                    -DUSE_AVRESAMPLE=OFF \
                    -DUSE_CHIPTUNE_GME=OFF \
                    -DUSE_CHIPTUNE_SID=ON \
                    -DUSE_CUVID=OFF \
                    -DUSE_FFMPEG=ON \
                    -DUSE_FFMPEG_VTB=OFF \
                    -DUSE_INPUTS=ON \
                    -DUSE_LASTFM=OFF \
                    -DUSE_LIBASS=ON \
                    -DUSE_LINK_TIME_OPTIMIZATION=OFF \
                    -DUSE_LYRICS=ON \
                    -DUSE_MEDIABROWSER=OFF \
                    -DUSE_MODPLUG=ON \
                    -DUSE_NOTIFY=OFF \
                    -DUSE_OPENGL2=OFF \
                    -DUSE_PORTAUDIO=ON \
                    -DUSE_PULSEAUDIO=OFF \
                    -DUSE_QML=OFF \
                    -DUSE_QT4=ON \
                    -DUSE_TAGLIB=ON \
                    -DUSE_VIDEOFILTERS=OFF \
                    -DUSE_VISUALIZATIONS=OFF \
                    -DUSE_XVIDEO=OFF \
                    -DUSE_YOUTUBE=ON

post-destroot {
    system "install_name_tool -id ${applications_dir}/${real_name}.app/Contents/MacOS/libqmplay2.dylib \
                    ${destroot}${applications_dir}/${real_name}.app/Contents/MacOS/libqmplay2.dylib"
    system "install_name_tool -change ${prefix}/lib/libqmplay2.dylib \
                    ${applications_dir}/${real_name}.app/Contents/MacOS/libqmplay2.dylib \
                    ${destroot}${applications_dir}/${real_name}.app/Contents/MacOS/QMPlay2"
    foreach dylib [ exec find ${destroot}${applications_dir}/${real_name}.app/Contents/MacOS/modules -name "\*.dylib" ] {
        regsub ":$" ${dylib} "" destroot_dylib_path
        regsub ${destroot} ${destroot_dylib_path} "" dylib_path
        system "install_name_tool -id ${dylib_path} ${destroot_dylib_path}"
        system "install_name_tool -change ${prefix}/lib/libqmplay2.dylib ${applications_dir}/${real_name}.app/Contents/MacOS/libqmplay2.dylib \
                    ${destroot_dylib_path}"
    }
}

notes "
${name} expects to have yt-dlp in ~/.qmplay2/ and use it for YouTube playback.\
After installation you could make a symlink to MacPorts-provided yt-dlp:\
\
ln -s ${prefix}/bin/yt-dlp ~/.qmplay2/
"

variant pulse description "Use Pulseaudio" {
    depends_lib-append \
                    port:pulseaudio
    configure.args-replace \
                    -DUSE_PULSEAUDIO=OFF -DUSE_PULSEAUDIO=ON
}
