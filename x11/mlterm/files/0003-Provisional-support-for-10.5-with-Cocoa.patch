From 01483da13f64472a88380e0edcddf4634ec76ee5 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <vital.had@gmail.com>
Date: Sat, 2 Aug 2025 05:01:50 +0800
Subject: [PATCH 3/4] Provisional support for 10.5 with Cocoa

diff --git uitoolkit/quartz/cocoa.m uitoolkit/quartz/cocoa.m
index 7ae34673..b0f77832 100644
--- uitoolkit/quartz/cocoa.m
+++ uitoolkit/quartz/cocoa.m
@@ -18,6 +18,12 @@
 #define USE_CGLAYER
 #endif
 
+#if MAC_OS_X_VERSION_MAX_ALLOWED >= 1060
+#define STRING_PBOARD_TYPE NSPasteboardTypeString
+#else
+#define STRING_PBOARD_TYPE NSStringPboardType
+#endif
+
 @interface MLTermView : NSView<NSTextInputClient> {
   ui_window_t *uiwindow;
   CGContextRef ctx;
@@ -113,7 +119,11 @@
 
 static void monitor_pty_dispatch(void *context) {
     ui_event_source_process();
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1060
     dispatch_sync_f(dispatch_get_main_queue(), NULL, exit_program_dispatch);
+#else
+    exit_program_dispatch(NULL);
+#endif
 }
 
 static void monitor_pty(void) {
@@ -123,8 +133,12 @@
   bl_priv_change_egid(bl_getgid());
 #endif
 
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1060
   dispatch_async_f(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0),
                   NULL, monitor_pty_dispatch);
+#else
+  monitor_pty_dispatch(NULL);
+#endif
 }
 
 /* Undocumented */
@@ -1605,7 +1619,7 @@
 void cocoa_clipboard_own(MLTermView *view) {
   NSPasteboard *pasteboard = [NSPasteboard generalPasteboard];
 
-  [pasteboard declareTypes:[NSArray arrayWithObject:NSPasteboardTypeString]
+  [pasteboard declareTypes:[NSArray arrayWithObject:STRING_PBOARD_TYPE]
                      owner:view];
 }
 
@@ -1616,7 +1630,7 @@
                                              length:len
                                            encoding:NSUTF8StringEncoding];
 
-    [pasteboard setString:str forType:NSPasteboardTypeString];
+    [pasteboard setString:str forType:STRING_PBOARD_TYPE];
     [str release];
   }
 }
@@ -1626,9 +1640,9 @@
   NSString *available;
 
   available = [pasteboard
-      availableTypeFromArray:[NSArray arrayWithObject:NSPasteboardTypeString]];
-  if ([available isEqualToString:NSPasteboardTypeString]) {
-    NSString *str = [pasteboard stringForType:NSPasteboardTypeString];
+      availableTypeFromArray:[NSArray arrayWithObject:STRING_PBOARD_TYPE]];
+  if ([available isEqualToString:STRING_PBOARD_TYPE]) {
+    NSString *str = [pasteboard stringForType:STRING_PBOARD_TYPE];
     if (str != nil) {
       return [str UTF8String];
     }

diff --git uitoolkit/quartz/cocoatouch.m uitoolkit/quartz/cocoatouch.m
index 8adcf68c..371f793b 100644
--- uitoolkit/quartz/cocoatouch.m
+++ uitoolkit/quartz/cocoatouch.m
@@ -137,8 +137,12 @@ static void monitor_pty(void) {
   bl_priv_change_egid(bl_getgid());
 #endif
 
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1060
   dispatch_async_f(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0),
                   NULL, monitor_pty_dispatch);
+#else
+  monitor_pty_dispatch(NULL);
+#endif
 }
 
 /* Undocumented */
diff --git uitoolkit/quartz/ui_event_source-cocoa.m uitoolkit/quartz/ui_event_source-cocoa.m
index 7e0fa5bf..daabd7e1 100644
--- uitoolkit/quartz/ui_event_source-cocoa.m
+++ uitoolkit/quartz/ui_event_source-cocoa.m
@@ -123,7 +123,11 @@ int ui_event_source_process(void) {
     tval.tv_usec = 100000; /* 0.1 sec */
     tval.tv_sec = 0;
 
+#if MAC_OS_X_VERSION_MIN_REQUIRED >= 1060
     dispatch_sync_f(dispatch_get_main_queue(), &ctx, ui_event_source_process_main);
+#else
+    ui_event_source_process_main(&ctx);
+#endif
 
     if (maxfd == -1 ||
         ((ret = select(maxfd + 1, &read_fds, NULL, NULL, &tval)) < 0 &&
