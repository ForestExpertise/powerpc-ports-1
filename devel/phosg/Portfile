# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               cmake 1.1
PortGroup               compiler_blacklist_versions 1.0
PortGroup               github 1.0
PortGroup               legacysupport 1.1

github.setup            fuzziqersoftware phosg b7d1d572541cc12560696da7d3c62ec9ff0ee4be
github.tarball_from     archive

# blacklisting to select C++20 capable compilers
compiler.blacklist-append {clang < 1300}
compiler.cxx_standard   2020

version                 2025.03.10
revision                0
categories              devel
maintainers             {alum.wpi.edu:arno+macports @fracai} openmaintainer
license                 MIT

description             Phosg is a basic C++ wrapper library around some common C routines.
long_description        {*}${description}

checksums               rmd160  7deb728aeda795c54af715ecf2b74596701c8267 \
                        sha256  649102c29db7ab3e113bf49267d811464d13a96fd288fa3611bc3b085ebc7ed1 \
                        size    164436

set pyver               3.11
set python_version      [string index ${pyver} 0][string range ${pyver} 2 end]

# https://github.com/fuzziqersoftware/phosg/pull/23
patchfiles              0001-CMakeLists-set-CMAKE_OSX_ARCHITECTURES-only-if-not-s.patch \
                        0002-Hash.hh-use-C-header.patch \
                        0003-Encoding.hh-use-C-headers-define-__STDC_FORMAT_MACRO.patch \
                        0004-Platform.hh-minor-fix-to-endianness-macros.patch \
                        0005-Image.hh-add-a-missing-header.patch \
                        0006-CMakeLists-ppc-also-needs-libatomic.patch \
                        0007-StringTest.cc-fix-endianness-in-floats-test-cases.patch

depends_build-append    port:python${python_version}

configure.args-append   -DPYTHON_EXECUTABLE=${prefix}/bin/python${pyver}

# src/JSON.cc:162:18: error: 'float_data' may be used uninitialized [-Werror=maybe-uninitialized]
configure.cxxflags-append \
                        -Wno-error=maybe-uninitialized

pre-test {
    # Test infrastructure uses /bin/ps, which is forbidden by sandboxing
    append portsandbox_profile " (allow process-exec (literal \"/bin/ps\") (with no-profile))"
}

# Several tests fail on PPC: https://github.com/fuzziqersoftware/phosg/issues/24
# 85% tests passed, 2 tests failed out of 13.
# Hash test fails due to wrong endianness in the test itself.
# Not sure why Process test fails.
test.run                yes
test.cmd                ctest
