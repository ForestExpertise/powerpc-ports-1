From 55709ad2c9f8620c3dad686810099c2982d62472 Mon Sep 17 00:00:00 2001
From: Sergey Fedorov <barracuda@macos-powerpc.org>
Date: Sun, 16 Mar 2025 19:39:31 +0800
Subject: [PATCH] process.cpp: fix for macOS < 10.9

Closes: https://github.com/NickvisionApps/libnick/issues/62
---
 src/system/process.cpp | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git src/system/process.cpp src/system/process.cpp
index d8b1d8e..9df8558 100644
--- src/system/process.cpp
+++ src/system/process.cpp
@@ -16,6 +16,7 @@
 #include <mach/mach.h>
 #include <sys/types.h>
 #include <sys/sysctl.h>
+#include <AvailabilityMacros.h>
 #endif
 
 #define PROCESS_WAIT_TIMEOUT 50
@@ -207,12 +208,23 @@ namespace Nickvision::System
         task_t task;
         if(task_for_pid(mach_task_self(), m_pid, &task) == KERN_SUCCESS)
         {
+    /* Code for modern macOS */
+    #if MAC_OS_X_VERSION_MIN_REQUIRED >= 1090
             task_vm_info_data_t info;
             mach_msg_type_number_t count{ sizeof(task_vm_info_data_t) };
             if(task_info(task, TASK_VM_INFO, reinterpret_cast<task_info_t>(&info), &count) == KERN_SUCCESS)
             {
                 return info.phys_footprint;
             }
+    /* Fallback for macOS < 10.9 */
+    #else
+            task_basic_info_data_t info;
+            mach_msg_type_number_t count{ TASK_BASIC_INFO_COUNT };
+            if(task_info(task, TASK_BASIC_INFO, reinterpret_cast<task_info_t>(&info), &count) == KERN_SUCCESS)
+            {
+                return info.resident_size;
+            }
+    #endif
         }
 #endif
         return 0L;
